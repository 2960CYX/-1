【方案 D】评论系统架构升级计划书 (无代码版)
1. 核心目标
访客 (未登录)：可以评论，但必须通过验证码验证。提交后，评论状态为**“待审核”**。

管理员 (已登录)：可以评论，无需验证码。提交后，评论**“自动通过”并即时显示**。

2. 计划拆解：后端 (RuoYi) 修改
您的任务是修改后端，使其能够“智能”地区分访客和登录用户。

2.1. 修改 BlogCommentController.java

目标：允许匿名访问“提交评论”接口。

操作：将 add() (新增评论) 方法上的 @PreAuthorize("isAuthenticated()") 注解替换为 @Anonymous。

2.2. 扩展 BlogComment 领域对象 (DTO)

目标：让后端能接收前端传来的验证码。

操作：在 BlogComment.java (或您的 DTO) 中，添加两个瞬态 (@Transient) 字段：code 和 uuid (以及它们的 getter/setter)。

2.3. 修改 BlogCommentServiceImpl.java (核心)

目标：实现“智能审核”逻辑。

操作：

注入您的验证码服务（例如 ValidateCodeService）。

重写 insertBlogComment() 方法。

在该方法内部，首先检查 SecurityUtils.getLoginUser()。

如果 (是登录用户)：

跳过所有验证码检查。

安全地从 loginUser 上下文中获取 userId 和 nickname 并设置到 comment 对象上（防止昵称伪造）。

设置特权：comment.setStatus("1"); (自动通过)。

如果 (是访客 / loginUser == null)：

执行安全检查：必须调用验证码服务，校验 comment.getCode() 和 comment.getUuid()。如果失败，验证码服务会自动抛出异常，阻止后续执行。

设置状态：comment.setStatus("0"); (待审核)。

comment.setUserId(null);。

（最后）执行 blogCommentMapper.insertBlogComment(comment)。

2.4. 重启服务

操作：必须重启 Java 后端服务使改动生效。

3. 计划拆解：前端 (Vitesse) 修改
您的任务是改造评论表单，使其能根据“登录状态”显示不同的形态。

3.1. 扩展 types/blog.ts

目标：让前端的 submitComment 函数可以发送验证码。

操作：在 CommentPayload 接口中，添加 code?: string 和 uuid?: string 两个可选字段。

3.2. 改造 pages/article/[id].vue (核心)

目标：让表单“智能化”。

setup 逻辑：

引入状态：导入 useAuthStore 并获取 isAuthenticated 和 profile 状态。

引入验证码：导入 fetchCaptchaImage 服务。添加 captchaImg, captchaEnabled 等 ref 状态。

创建 loadCaptcha 函数：此函数只在 !isAuthenticated 时才执行获取验证码的逻辑。

自动填充：使用 watch 或 computed，当 isAuthenticated 为 true 时，自动将 commentForm.nickname 设置为 profile.nickName。

生命周期：在 onMounted 和 watch(isAuthenticated) 中调用 loadCaptcha()，确保访客状态下验证码能被正确加载。

handleSubmitComment 逻辑 (重写)：

创建一个 payload 对象。

如果 (已登录)：payload 中只包含 content。（后端会从 Token 中获取 nickname 和 userId）。

如果 (未登录)：必须校验“昵称”和“验证码”是否填写。payload 中必须包含 nickname, content, code, uuid。

调用 submitComment(payload)。

在 try...catch 的 finally 块中处理 submitting 状态。

（关键反馈） 在 try 成功后：

如果已登录，调用 notifySuccess('评论已发布') 并且刷新评论列表（refreshComments()）。

如果未登录，调用 notifySuccess('评论提交成功，待审核') 并且只刷新验证码（loadCaptcha()）。

template 模板 (重构)：

昵称输入框：必须添加 :disabled="isAuthenticated" 和 :readonly="isAuthenticated"。

验证码区域：必须使用 v-if="!isAuthenticated && captchaEnabled" 包裹，使其只对需要它的访客显示。

提示文字：必须使用 v-if="isAuthenticated" 来显示“您的评论将自动通过”，并用 v-else 显示“评论经博主审核后才会对外展示”。

4. 验证清单 (新)
访客测试：在隐身模式下，能看到昵称和验证码表单。提交错误验证码，提示失败并刷新验证码。提交正确验证码，提示“待审核”，评论不显示。

管理员测试：登录后，昵称框自动填充且只读，验证码区域消失。提交评论，提示“已发布”，评论立即显示在列表顶部。
# 夜读工坊 / 夜读志：中文本地化与品牌统一改造记录
时间：2025-11-05

本次改造聚焦将 Vitesse 站点全面本地化为中文，并统一品牌为“夜读工坊 / 夜读志”，同时确保在后端（若依）未返回数据时，站点仍能展示友好的中文内容与默认信息。

改动摘要
- 统一品牌与文案：导航、页脚、退出提示与联络邮箱改为中文；站点标题与描述突出中文前端博客定位。
- 中文后备文案：服务层为站点信息提供完整中文 fallback，包括邮箱、价值主张与里程碑。
- 首页与关于页：英雄区、CTA、策展标签、空状态及“关于”页面全部中文化，阅读体验一致。
- 规范引入顺序：文章详情页调整 import 顺序以满足 lint 规则。

涉及文件与要点
- `src/components/ArcanumLayout.vue`（行 40、70、127）：统一品牌为“夜读工坊 / 夜读志”，本地化退出提示与页脚文案，并替换为中文联络邮箱。
- `src/App.vue`（行 6）：更新默认站点标题与描述，明确“中文前端博客”定位。
- `src/services/blog.ts`（行 29–71）：全面替换站点信息后备文案、邮箱与价值主张/里程碑中文描述，保证若依未返回数据时仍展示中文内容。
- `src/pages/index.vue`（行 31–296）：重写首页英雄区文案、CTA、策展标签与空状态提示，统一为中文阅读体验。
- `src/pages/about.vue`（行 8–133）：以中文重新组织“关于”页面的标题、方法论、里程碑与联系段落。
- `index.html`（行 1–22）：将 `html` 语言设为 `zh-CN`，并以中文 `noscript` 提示未开启 JavaScript 的访客。
- `src/pages/article/[id].vue`（行 1–13）：调整 import 顺序以满足现有 lint 规则。

验证
- 已执行 `pnpm lint`，仅剩 `vue/attributes-order` 的非阻塞警告，可按需继续优化属性顺序。

变更统计（参考）
- 6 files changed +557 −553
- `index.html` +23 −23
- `src/App.vue` +29 −29
- `src/components/ArcanumLayout.vue` +137 −135
- `src/pages/about.vue` +133 −133
- `src/pages/article/[id].vue` +5 −6
- `src/services/blog.ts` +230 −227

后续建议
- 可进一步统一其它页面残留英文文案，或引入多语言切换（i18n）。
- 若需品牌视觉统一（Logo/色板/组件文案），可补充设计规范并批量替换。

——
以下为此前的方案文档原文保留：
 
 【方案 D】评论系统架构升级计划书 (无代码版)
 1. 核心目标
 访客 (未登录)：可以评论，但必须通过验证码验证。提交后，评论状态为**“待审核”**。