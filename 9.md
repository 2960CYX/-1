# 阶段进度 - 2025-11-02

## 今日完成
- 阶段一（环境与基础设施）闭环：补充 `VITE_API_TIMEOUT`、`VITE_ENABLE_MOCK`，并在 `vite.config.ts` 配置 `/api` 代理；重写 `src/utils/request.ts`，实现请求超时、401 统一跳转、本地 Token 工具与通知通道。
- 鉴权链路交付：`src/services/auth.ts`、`src/stores/auth.ts`、`src/modules/auth.ts` 与 `src/components/ArcanumLayout.vue` 协同完成后台管理员登录、路由守卫与入口展示。
- 阶段二（数据接入）落地：新增 `src/types/blog.ts`、`src/services/blog.ts`、`src/composables/useBlog.ts` 实现文章/分类/标签/站点信息的类型、服务与缓存；重构 `src/pages/index.vue`、`src/pages/about.vue` 使用服务层数据并补充筛选、骨架与空态。
- 补完阶段二余项：扩展博客评论类型与服务能力，新增 `useArticleComments` 组合式与缓存；重构 `src/pages/article/[id].vue` 接入服务层、骨架/错误/空态与评论表单；统一请求拦截器返回结构，服务层改用 axios 响应数据。
 - 本地执行 `pnpm run typecheck` 通过，确认新增 TypeScript 逻辑无类型告警（仓库原有 lint 仍待统一处理）。
 - 修复桌面端登录页切换时的水平右移：在 `src/styles/main.css` 增加 `html { scrollbar-gutter: stable both-edges; }`，并用 `@supports not (scrollbar-gutter: stable) { html { overflow-y: scroll; } }` 作为兼容回退，稳定滚动条占位避免首页/登录页视口宽度变化导致的抖动。
 
 ## 校验
- ✅ `pnpm run typecheck`
- ⚠️ `pnpm run lint` 仍因历史格式问题失败（未在本轮改动范围内处理）

## 后续建议
1. 进入阶段三：接入评论/通知 UI（Toast），提升加载与操作反馈，并继续完善鉴权态界面。
2. 梳理后台管理员与前台访客的入口区分，结合后端策略评估是否开放前台登录。
3. 为阶段四提前规划：补充服务层单元测试与端到端冒烟脚本，保障后续发布质量。

## 登录修复与验证码对齐（2025-11-02 补记）

- 背景与现象
  - 前台登录无响应，控制台出现 “Unchecked runtime.lastError: Could not establish connection. Receiving end does not exist.”；并出现 “[ERROR] 操作成功” 的通知（实为后端响应解析不一致导致的误报）。

- 修复内容
  - `src/services/auth.ts`
    - 新增 `fetchCaptchaImage()`，请求 `/captchaImage`，并按 RuoYi 接口的顶层返回结构读取 `captchaEnabled`、`uuid`、`img`。
    - 保持 `login()` 使用 `skipAuth: true`，以便未登录时可调用登录接口。
  - `src/pages/login.vue`
    - 表单增加 `code`、`uuid` 字段。
    - 在验证码开启时自动加载并展示验证码图片，支持点击刷新；登录失败时自动刷新验证码。
    - 登录提交时根据开关携带 `username`、`password`、`code`、`uuid`，与后端期望字段对齐。
  - `src/components/ArcanumLayout.vue`
    - 增加极简通知栏，订阅 `arcanum:notification` 事件，统一展示错误/成功/提示消息，默认显示 3 秒并自动消失。
  - `src/stores/auth.ts`
    - 兼容后端两种返回结构：`token`/`expiresIn` 既可能在顶层，也可能在 `data` 中；按优先顺序解析以避免误报。
    - `hydrate()` 获取 `getInfo` 时，同样兼容顶层与 `data` 嵌套的 `user`、`permissions`、`roles`。
  - 未改动：`src/utils/request.ts` 拦截器逻辑沿用；`/captchaImage` 通过 `skipAuth` 允许匿名访问（后端 `SecurityConfig` 已放行）。

- 影响与结果
  - 登录现在可正常跳转；验证码开启时交互顺畅，失败自动刷新验证码。
  - 错误通知在右上角提示 3 秒，避免静默失败。

- 备注
  - “Unchecked runtime.lastError...” 多为浏览器扩展的后台页通信报错，非应用逻辑问题；可忽略。
  - 若后端关闭验证码（`selectCaptchaEnabled()` 返回 false），登录页会自动隐藏验证码输入与图片。

- 验证步骤
  - 打开登录页；若后端开启验证码，应显示图片与输入框，可点击刷新。
  - 使用 `admin/admin123` 登录；失败时观察通知与验证码刷新；成功后跳转首页并调用 `/getInfo` 正常填充用户信息与权限。

- 相关文件
  - `v1/web/my-vitesse-app/src/services/auth.ts`
  - `v1/web/my-vitesse-app/src/pages/login.vue`
  - `v1/web/my-vitesse-app/src/components/ArcanumLayout.vue`
  - `v1/web/my-vitesse-app/src/stores/auth.ts`

- 后续建议
  - 在登录失败时增加更细粒度的错误文案（验证码错误/过期、用户名或密码错误、账号锁定等）。
  - 根据后端配置动态展示验证码说明与刷新频率限制。
  - 为登录流程添加端到端测试（含验证码开/关场景），保障发布质量。
# 评论提交登录与用户信息绑定（文章详情页）

日期：2025-11-02

## 目标
- 后端：强制“发表评论”接口仅允许已登录用户调用，并在落库时自动绑定评论的 `userId` 与 `nickname`。
- 前端：未登录时隐藏评论表单并提示登录；已登录时自动使用当前用户昵称，阻止匿名提交并引导跳转登录。

## 后端改动
- 文件：`v1/api/RuoYi-Vue/ruoyi-admin/src/main/java/com/ruoyi/blog/controller/BlogCommentController.java`
- 关键点：
  - 为新增评论接口添加登录校验注解：`@PreAuthorize("isAuthenticated()")`
  - 在写库前填充当前登录用户信息：
    - `Long userId = SecurityUtils.getUserId();`
    - `String nickname = Optional.ofNullable(SecurityUtils.getLoginUser())\n        .map(LoginUser::getUser)\n        .map(SysUser::getNickName)\n        .filter(s -> s != null && !s.isEmpty())\n        .orElse(SecurityUtils.getUsername());`
    - `comment.setUserId(userId); comment.setNickname(nickname);`
- 影响：
  - 未登录用户调用 `/blog/comment` 将返回 401/403，由前端拦截器统一清 Token、跳转登录页。
  - 服务器端以登录用户为准覆盖 `nickname` 字段，避免客户端伪造昵称。

## 前端改动
- 文件：`v1/web/my-vitesse-app/src/pages/article/[id].vue`
- 关键点：
  - 引入鉴权状态：`useAuthStore` + `storeToRefs` 获取 `isAuthenticated`、`profile`。
  - 自动昵称：`displayNickname = computed(() => profile.nickName || profile.userName || '')`，并以 `watch` 在登录态变化时同步到表单。
  - 提交拦截：未登录时在 `handleSubmitComment` 中弹错并跳转 `router.push('/login?redirect=' + route.fullPath)`。
  - 表单门禁：模板使用 `v-if="!isAuthenticated"` 显示登录提示；`v-else` 展示评论表单，昵称输入框只读显示当前用户昵称。
  - 细节修正：修复按钮类名误拼（`justify-center`）。
- 影响：
  - 未登录用户在文章页只能看到登录提示；登录后评论表单可用，昵称由登录信息自动填充。
  - 提交成功后自动刷新评论列表（沿用 `useArticleComments` 组合式逻辑）。

## 验证步骤
1. 未登录打开任意文章详情页：评论区显示“请先登录后再发表评论”，点击跳转到登录页。
2. 登录成功自动返回文章页：评论表单可见，昵称显示为当前用户昵称且不可编辑。
3. 输入评论内容后提交：提示“评论已发布”，评论列表刷新。
4. 打开控制台网络面板：确认 `POST /blog/comment` 响应为 200；未登录场景为 401/403 并触发拦截器跳转。

## 注意事项
- 若后端允许匿名访问的 `@Anonymous` 采集机制仍放行 `/blog/comment`，以 `@PreAuthorize("isAuthenticated()")` 为准（方法级更严格）。
- Axios 拦截器（`src/utils/request.ts`）在 401 时会清理 Token 并跳转登录；确保登录页支持 `redirect` 返回原路。
- 服务器端覆盖昵称属安全策略，前端昵称展示仅用于 UI 友好，不参与权限判断。
 - 开发代理依赖 `.env.development.local`：请设置 `VITE_API_BASE_URL`、`VITE_API_TIMEOUT`、`VITE_ENABLE_MOCK=false`，否则 `/api` 可能同源失败。

### 评论审核来源与本次调整
- 来源说明：评论的“审核/显示”来自我们生成的 `blog_comment.status` 字段约定（0=待审核，1=已显示），属于业务模块设计，并非 RuoYi 框架强制逻辑。
- 本次处理：后端在插入评论时统一设置 `status=1` 与 `delFlag=0`，前端提示文案同步改为“评论已发布”。如需恢复审核流程，可改回 `status=0` 并调整前端文案。

## 回滚指引
- 后端：移除 `@PreAuthorize("isAuthenticated()")` 并取消服务端昵称覆盖（同时评估风控/审核）。
- 前端：恢复匿名表单显示与提交分支，去除登录提示与跳转逻辑。

## 相关文件
- 后端：`ruoyi-admin/.../BlogCommentController.java`、`com.ruoyi.common.utils.SecurityUtils`
- 前端：`src/pages/article/[id].vue`、`src/stores/auth.ts`、`src/composables/useBlog.ts`、`src/services/blog.ts`

---
补充说明（本次增量与兼容性）
- 登录页已接入验证码接口 `fetchCaptchaImage()` 并对齐 RuoYi 开关与返回结构；与评论鉴权改动相互独立。
- 请求拦截器统一处理 401 并附带 `redirect`，确保用户在登录后返回原页面继续操作。

---
交叉确认
- 本节的验证点已纳入 `v1/8.md` 第 6 节“当前已验证”，覆盖：登录页验证码与 401 重定向、文章页评论门禁与昵称只读、统一请求封装与错误通知、文章详情与评论服务层接入、首页与关于页服务层驱动。

## 评论列表显示修复（2025-11-02 增量）

### 现象
- 前台“评论已发布”提示出现，但评论列表不显示新评论；刷新后仍不可见。

### 根因
- 后端评论列表接口仍受后台权限限制（`@PreAuthorize('blog:comment:list')` 或未显式开放），普通用户/前台无法拉取列表。
- 列表查询未指定排序，旧评论占满第一页，导致新评论落在下一页，看起来像“未显示”。

### 修复内容
- 开放评论列表匿名访问：
  - 文件：`v1/api/RuoYi-Vue/ruoyi-admin/src/main/java/com/ruoyi/blog/controller/BlogCommentController.java`
  - 变更：为 `list()` 方法添加 `@Anonymous` 注解，允许前台拉取评论列表；`add()` 保持 `@PreAuthorize("isAuthenticated()")`（仅登录用户可发表评论）。
- 显式倒序排序，确保新评论优先：
  - 文件：`v1/api/RuoYi-Vue/ruoyi-admin/src/main/resources/mapper/blog/BlogCommentMapper.xml`
  - 变更：在 `selectBlogCommentList` 末尾添加 `order by bc.create_time desc, bc.comment_id desc`。
- 前端本地环境对齐：
  - 文件：`v1/web/my-vitesse-app/.env.development.local`
  - 配置：`VITE_API_BASE_URL=http://localhost:8080`、`VITE_API_TIMEOUT=10000`、`VITE_ENABLE_MOCK=false`，确保请求直达后端并禁用 mock。

### 验证步骤
1. 启动前端：`pnpm dev`，打开 `http://localhost:3334/`。
2. 登录后在文章详情页发表评论：提示“评论已发布”。
3. 网络面板应看到：`POST /blog/comment` 返回 200，随后 `GET /blog/comment/list?articleId=<ID>` 返回列表，且新评论位于第一页顶部。
4. 未登录场景提交评论：`POST /blog/comment` 返回 401/403，前端拦截器清 Token 并跳转登录页（符合预期）。

### 影响与注意
- 列表匿名开放仅影响读取，不影响发表评论的登录限制；安全策略保持不变。
- 若需开启“评论审核后显示”，可在服务层将 `status` 设为 `'0'`，并在列表查询增加 `status='1'` 过滤、同步前端文案为“待审核”。

### 回滚指引
- 如需恢复“列表需后台权限”：移除 `@Anonymous` 并恢复 `@PreAuthorize`；前端需改为从管理员端查看或使用带权限的用户。
