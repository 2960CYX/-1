# v1.2.7 精简访客 AI 问答窗口设计

## 1. 版本定位与目标
- **版本代号**：Help Chat Lite（继承 `12.md` 的功能集，聚焦访客问答）。
- **覆盖页面**：`web/my-vitesse-app` 的所有公开访问页面（含首页、文章详情、列表页等）。
- **主要目标**：
  1. 为未登录访客提供一个轻量、无干扰的 AI 问答入口。
  2. 优化上下文注入体验——访客可从文章卡片/详情一键拉取摘要，自动影响回答。
  3. 复用 DeepSeek OpenAI 兼容接口（参考 `env.development.download`），默认非流式、快速响应。
  4. 提供可观测性：在不影响主业务的前提下，输出基础埋点（打开、提问、失败）。

## 2. 用户旅程（Visitor Journey）
1. **入口发现**：访客在页面右下角看到 36px 圆形“AI”浮动按钮（滚动时长期固定）。
2. **打开窗口**：按钮点击后，窗口以 320×420 px（移动端 100% 宽、高度 65%）展开，默认聚焦输入框。
3. **上下文注入**：
   - 首页/文章列表/详情维持 `12.md` 里“加入对话”按钮，成功加入后顶部 toast 提示。
   - 对话窗口顶部展示“参考资料”栏（最多 2 条，显示文章标题+来源）。
4. **提问与响应**：
   - 输入区限制 400 字，提供“Enter 发送 / Shift+Enter 换行”提示。
   - 发送后立即展示访客消息气泡，并进入 loading skeleton；当后端返回 content 后替换。
5. **失败体验**：
   - 请求异常：在窗口顶部展示红色轻提示“AI 暂时不可用，请稍后再试”，保留用户输入以便重试。
   - 超时（>15s）：自动取消 loading，提示重试。
6. **关闭与状态保留**：窗口关闭后仍保留最近一次对话记录，刷新页面清空。

## 3. 界面与交互规范
| 模块 | 说明 |
| --- | --- |
| 浮动按钮 | 圆角 999px，渐变 `#1E88FF → #5C6CFF`，悬停放大 1.05。Badge 显示“New” 48h |
| 窗口容器 | 阴影 `0 12px 32px rgba(15,23,42,0.18)`，圆角 16px，可拖动但限制在视口内 |
| 头部 | 左侧标题“AI 小助手 (Beta)”，右侧包含“清空”“最小化”icon |
| 消息区 | 背景 `#0F172A` 10% 透明覆层，滚动条隐藏。访客气泡右对齐、深色；AI 气泡左对齐、浅色，支持 Markdown（代码块、列表） |
| 输入区 | 背景色 `#F8FAFC`，含 2 行 auto-resize textarea、发送按钮、token 消耗提示 |
| Empty State | 若无消息，展示 illustration + “向我提问：例如『请总结首页推荐的文章』” |

### 布局草图（桌面端）
```
┌──────────────────────────────┐
│ AI 小助手 (Beta)   [清空][－] │
├──────────────────────────────┤
│ 参考资料                     │
│ 1. 《标题 A》 文章           │
│ 2. 《标题 B》 文章           │
├──────────────────────────────┤
│ 访客：...                    │
│ AI：...                      │
│ …                            │
├──────────────────────────────┤
│ 提问输入框……   [发送]        │
└──────────────────────────────┘
```

## 4. 前端实现拆解（web/my-vitesse-app）
1. **状态管理 (`src/stores/chat.ts`)**
   - 新增 `conversationId`（用于埋点/并发控制）、`toast` 状态以及 `maxContextArticles=2`。
   - `sendUserMessage` 内统一拼装请求：`messages = system (context snippets) + history + 当前 user`.
   - 超时控制：`AbortController` + 15s timeout。
2. **服务层 (`src/services/chat.ts`)**
   - 默认读取 `.env` 中的 `VITE_CHAT_API_URL / KEY / MODEL`，若 `API_URL` 为空则回退 `/api/chat/completion`。
   - Headers：`Content-Type: application/json`，可选 `Authorization`.
   - 解析顺序：`data.content` → `content` → `choices[0].message.content`（兼容 DeepSeek/OpenAI）。
3. **组件 (`src/components/HelpChat.vue`)**
   - 重构为“按钮 + 面板”两段式：按钮继续悬浮，面板使用 `<Teleport to="body">` 防止被父容器裁剪。
   - 访客态 UI：无登录依赖，所有文案以访客为主；若后续需要登录能力，可在 store 增加鉴权标志。
   - Loading skeleton：在 AI 回答区域显示 3 行 placeholder。
   - Markdown 渲染：沿用现有 `Prose`/`Markdown` 组件或简易 `marked`。
4. **入口挂载**
   - `src/components/ArcanumLayout.vue` 继续引入 `<HelpChat />`。
   - 文章卡片、详情页保留 `addArticleToContext` 按钮，文案更新为“AI 引用此文”。
5. **埋点（可选）**
   - 在 store 内触发 `track('ai_chat_open')`、`track('ai_chat_send', {withContext: true/false})`、`track('ai_chat_error', {code})`；后续可接入现有埋点服务。

## 5. 后端 / API约束
| 项 | 要求 |
| --- | --- |
| 接口路径 | `/chat/completion`（经由 `/api` 代理或由 `VITE_CHAT_API_URL` 直连） |
| 请求体 | `{ messages: [...], model: <env 或前端下发>, stream: false }` |
| 返回体 | `{ content: "..." }` 或 `choices[0].message.content` |
| 鉴权 | 若 `VITE_CHAT_API_KEY` 存在，前端会携带 `Authorization: Bearer <key>`；后端需验证 |
| 限流 | 建议使用 IP + UA 级别限流，避免公开访客滥用 |
| 日志 | 标注 `conversationId`，以便排查 |

## 6. 环境变量（来自 `env.development.download`）
```ini
VITE_CHAT_API_URL=https://api.deepseek.com/v1/chat/completions
VITE_CHAT_API_KEY=sk-f5e4d3e348bb4849ad990b3ee182de7d
VITE_CHAT_MODEL=deepseek-chat
VITE_API_BASE_URL=http://localhost:8080
```
- **开发默认**：指向 DeepSeek OpenAI 兼容接口，模型 `deepseek-chat`，无需本地代理即可调用。
- **生产建议**：
  - 若走自建后端代理，填 `VITE_API_BASE_URL=https://your-domain` 并清空 `VITE_CHAT_API_URL`。
  - 若继续直连 DeepSeek，确保前端部署环境能安全保管 API Key，必要时转移到后端。

## 7. 测试 & 验收清单
1. 浮动按钮在桌面/移动端均可见，点击后窗口开启并可关闭。
2. 输入消息后，立即显示访客气泡，15s 内收到 DeepSeek 返回；若超时，提示重试。
3. “AI 引用此文”操作将文章加入上下文，并在窗口顶部展示清单；超过 2 条后覆盖最旧的一条。
4. 错误（断网、403、429）会被 toast 提示，消息区保留用户输入。
5. `.env` 变量缺失时，控制台抛出明确错误，引导补全配置。

## 8. 迭代建议
1. **流式输出**：后续可扩展 SSE，发送 `stream: true` 并在组件内逐 token 渲染。
2. **多语言**：将文案接入现有 i18n，便于面向海外用户。
3. **访客会话持久化**：使用 `localStorage` 保存最近一次对话，刷新后恢复。
4. **上下文富化**：允许访客上传截图/文本（需安全审查）以提升回答准确度。

> 本方案基于 `12.md` 的实现现状与 `env.development.download` 的 DeepSeek 配置，面向 v1.2.7 聚焦“访客问答”体验，可直接交付至设计/开发评审。

