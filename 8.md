% Arcanum 前端接入若依后端任务拆解

## 1. 项目目标
- 将当前使用静态假数据的 Vitesse 前端（Arcanum 模板）切换为消费若依（RuoYi）后端提供的真实业务数据。
- 保持现有页面视觉与交互，同时补充鉴权、数据状态处理、错误提示等生产级体验。
- 为后续自动化迭代打下基础：配置化接口、统一数据服务层、稳定的本地/测试环境。

## 2. 前置准备
- **确认后端接口**：确定若依版本、部署方式、基础 URL、鉴权方案（JWT/Token/Session）。
- **数据库初始化**：准备与后端一致的数据表和测试数据，确保若依接口可返回有效记录。
- **环境变量规划**：在 `v1/web/my-vitesse-app/.env.development.local` 与生产环境变量里新增 `VITE_API_BASE_URL`、`VITE_API_TIMEOUT`、`VITE_ENABLE_MOCK=false` 等键。
- **权限账户**：准备至少一组可访问全部页面的测试账号，收集不同角色（管理员/访客）的权限矩阵。

## 3. 技术架构决策
- **请求封装**：在 `src/utils/request.ts` 基于 `fetch` 或 `axios` 封装统一请求实例，集成 Token 注入、错误拦截、重试策略。
- **服务层**：在 `src/services/*` 目录按业务拆分模块（如 `auth.ts`、`article.ts`、`meta.ts`、`user.ts`），每个模块导出 Promise API。
- **状态管理**：评估是否引入 Pinia；若继续使用组合式 API，则为关键数据（文章列表、分类、标签、用户信息）创建可复用的 `useXxx` composable。
- **类型约束**：为若依返回的数据定义 `src/types/` 下的 TypeScript 接口，结合 `zod`/`type-fest` 做最小校验。

## 4. 阶段任务拆解

### 阶段 1：环境与基础设施
1. 在 `.env.*` 文件中新增后端配置；更新 `vite.config.ts` 以支持代理开发（如 `/api` → 若依网关）。
2. 创建 `src/utils/request.ts`（或增强现有封装）：实现基地址、超时、Token header 注入、错误消息弹窗。
3. 搭建鉴权流程：
   - 登录页/弹窗对接 `/login` 接口。
   - 成功后缓存 Token（`localStorage` + 内存），失败时清除状态。
   - 在路由守卫或布局层检测登录状态，自动刷新或跳转登录。

### 阶段 2：业务数据接入
1. **文章/内容模块**：
   - 对接若依对应的文章列表、详情、分类、标签接口。
   - 替换 `src/pages/index.vue`、`about.vue` 中的假数据为服务层调用。
   - 增加加载、空状态、错误显示组件。
2. **元数据模块**：
   - 补充服务接口获取站点信息（Banner、CTA 文案等），如若依侧暂无，约定扩展字段。
3. **搜索/筛选**：
   - 若前端目前本地过滤，改为调用后端查询（分页、关键词、分类筛选）。
4. **缓存策略**：
   - 在 `useXxx` composable 内实现基础缓存或 `swrv` 风格的请求复用。

### 阶段 3：后台交互与用户体验
1. **权限处理**：
   - 根据角色返回不同菜单/数据块；在布局组件中控制按钮显示。
2. **操作反馈**：
   - 为新增/编辑/删除操作增加若依接口联调；请求状态（loading、success、error）在 UI 中透出。
3. **日志与监控**：
   - 若依侧记录请求日志，前端在 `request` 拦截器中打印关键调试信息（可通过环境变量开关）。

### 阶段 4：质量保障
1. **类型与单元测试**：为服务层编写基础单元测试（可用 Vitest），验证接口返回字段映射。
2. **端到端验证**：使用 Playwright/Cypress 覆盖关键用户流程（登录 → 查看文章 → 筛选）。
3. **性能与可用性**：评估接口响应时间，必要时启用懒加载、骨架屏。
4. **部署前检查**：更新 CI/CD（若有），在构建时注入生产环境变量并执行 smoke test。

## 5. 数据映射清单（示例）
- `posts` 列表：`id`、`title`、`summary`、`coverUrl`、`publishedAt`、`authorName`、`categoryId`。
- `categories`：`id`、`name`、`slug`、`articleCount`。
- `tags`：`id`、`label`、`usageCount`。
- `siteInfo`：`heroTitle`、`heroSubtitle`、`ctaText`、`ctaLink`、`contactEmail`。
- 登录返回：`token`、`expiresIn`、`roles`、`permissions`、`userProfile`。

> 若依默认实体若与上述不符，需要补充 DTO 或在服务层做字段映射。

## 6. 当前已验证
- 登录页验证码接入与 401 重定向登录后返回原路。
- 文章详情页评论需登录门禁与提交逻辑生效，昵称只读展示。
- 统一请求封装与错误通知通道生效（axios 拦截器、超时、Token 注入）。
- 文章详情与评论已接入服务层与组合式，类型检查通过。
- 首页与关于页已改为服务层驱动并移除假数据。

## 7. 自动化协作指引
1. 先让 AI 工具完成阶段 1 的配置文件与请求封装，提交变更、跑基础测试。
2. 逐页指派任务（首页 → 关于页 → 其他页面）替换数据来源，确保每步可回滚。
3. 每完成一个后台操作流程（如登录、文章列表），要求 AI 产出联调说明与验证步骤。
4. 阶段 4 的测试与优化可在主功能稳定后集中执行，必要时拆成单独里程碑。

---
最后更新：2025-01-06

---

## 本版本额外完成项（相对 7.md 的增量）
- 已落地统一请求封装：`src/utils/request.ts` 采用 axios，支持 `Authorization` 注入、统一错误通知、401 清理会话并携带 `redirect` 跳转登录。
- 代理与环境：在 `vite.config.ts` 根据 `VITE_API_BASE_URL` 与 `VITE_ENABLE_MOCK=false` 启用 `/api` 代理重写。
- 服务层与类型：完成 `src/services/blog.ts` 与 `src/types/blog.ts`，包含文章/分类/标签/站点信息、评论列表与评论提交；站点信息引入兜底常量与合并策略。
- 组合式：新增并接入 `src/composables/useBlog.ts`（含列表/详情/评论缓存），文章详情页已切换为服务层与组合式驱动。
- 鉴权与验证码：`src/services/auth.ts` 新增 `fetchCaptchaImage()` 并在登录页对齐验证码开关/图片/刷新；登录与 `getInfo` 兼容顶层与 `data` 字段结构；`skipAuth` 用于未登录时可访问登录与验证码接口。
- 评论门禁：文章详情页在未登录时隐藏评论表单并提示登录，已登录时自动显示昵称并允许提交（昵称最终由后端覆盖）。

## 代理生效说明（补充）
- 开发代理仅在以下条件同时满足时启用：
  - `.env.development.local` 设置了有效的 `VITE_API_BASE_URL`；
  - `VITE_ENABLE_MOCK=false`。
- 若未配置 `VITE_API_BASE_URL`，请求将使用 `baseURL='/api'` 并同源发送，可能无法到达后端。建议在本地环境文件中显式配置。
