# 帮助对话窗口集成与使用说明

本文档说明本次在前端项目中完成的“帮助对话窗口（Help Chat）”功能的整体设计、使用方法、后端对接与可配置项，便于快速验证与上线。

## 功能概述

- 在所有页面右下角提供“帮助对话”浮动按钮，点击后打开对话窗口。
- 支持将文章加入对话上下文：在首页文章卡片、文章详情页点击“加入对话”，会把该文章的片段加入对话的系统提示，提升回答准确性。
- 对话窗口可直接输入问题，消息会调用后端聊天接口并展示回复。
- 顶部有轻量通知（toast），用于提示加入文章、错误信息等。

## 代码变更

以下文件已新增或修改（相对 `web/my-vitesse-app` 根目录）：

- 新增 `src/stores/chat.ts`：Pinia 会话状态（是否打开、loading、messages、contextArticles）及方法（`addArticleToContext`、`sendUserMessage`、`toggle`、`clear`）。
- 新增 `src/services/chat.ts`：聊天接口封装，支持自定义 API 地址与专用 `Authorization: Bearer <key>` 头；兼容多种返回结构（`content` / `data.content` / `choices[0].message.content`）。
- 新增 `src/components/HelpChat.vue`：对话窗口组件（浮动按钮、消息列表、输入框、已加入文章显示）。
- 修改 `src/components/ArcanumLayout.vue`：在全局布局底部挂载 `<HelpChat />`，确保所有页面可用。
- 修改 `src/pages/article/[id].vue`：在文章详情信息区添加“加入对话”按钮，调用 `chat.addArticleToContext(articleId)`。
- 修改 `src/pages/index.vue`：为精选文章与列表卡片添加“加入对话”按钮，支持一键加入上下文。

## 启动与预览

- 安装依赖：`pnpm install`
- 启动开发服务器：`pnpm dev`
- 预览地址：`http://localhost:3333/`

## 使用说明

- 在任意页面点击右下角“对话”按钮打开窗口。
- 在首页或文章详情页点击“加入对话”，会把该文章的摘要/正文片段加入对话上下文（系统消息部分）。
- 在输入框直接提问，消息会携带上下文一并发送到后端聊天接口；收到回复后展示在窗口内。
- 点击“清空”可重置消息与上下文。

## 后端对接

### 代理与地址

- 开发环境代理由 `vite.config.ts` 控制：
  - 当设置 `VITE_API_BASE_URL` 时，`/api/*` 会代理到该地址并移除 `/api` 前缀。
  - 聊天默认走代理：前端请求路径为 `'/api/chat/completion'`，后端实际处理路径为 `${VITE_API_BASE_URL}/chat/completion`。
- 也可直接设置绝对地址（不走代理）：在前端 `.env` 中设置 `VITE_CHAT_API_URL`（例如 `https://your-host/chat/completion`）。

### 前端环境变量

将以下变量写入前端项目根目录的 `.env.development.local` 或 `.env.production`：

- `VITE_API_BASE_URL`：后端基础地址（开发环境走代理时需要）。
- `VITE_CHAT_API_URL`：聊天接口完整地址（设置后不走代理）。
- `VITE_CHAT_API_KEY`：聊天专用密钥（如接口需要），将随请求以 `Authorization: Bearer <key>` 头发送。

#### DeepSeek 配置示例（OpenAI 兼容）

- 使用 DeepSeek 官方域名（兼容 OpenAI 路由）：
  - `VITE_CHAT_API_URL=https://api.deepseek.com/v1/chat/completions`
  - `VITE_CHAT_API_KEY=你的实际密钥（示例以 sk- 开头）`
  - `VITE_CHAT_MODEL=deepseek-chat`（非思考模式）或 `deepseek-reasoner`（思考模式）

- 说明：
  - base_url 可使用 `https://api.deepseek.com` 或 `https://api.deepseek.com/v1`。
  - deepseek-chat / deepseek-reasoner 都映射到最新的 DeepSeek-V3.2-Exp，其中 chat 为非思考模式、reasoner 为思考模式。

### 请求与响应

- 前端请求体（`POST` 至 `VITE_CHAT_API_URL` 或代理路径）：

```json
{
  "messages": [
    { "role": "system", "content": "《文章标题》\n文章片段..." },
    { "role": "user", "content": "用户问题" }
  ],
  "model": "可选模型标识",
  "stream": false,
  "extra": { "any": "扩展字段" }
}
```

- 前端兼容以下返回格式之一：
  - `{ "content": "回复内容" }`
  - `{ "data": { "content": "回复内容" } }`
  - OpenAI 风格：`{ "choices": [{ "message": { "content": "回复内容" } }] }`

如你的后端结构不同，可在 `src/services/chat.ts` 中调整解析逻辑。

### 后端实现建议（RuoYi）

- 在 `api/RuoYi-Vue/ruoyi-admin` 工程中实现 `POST /chat/completion` 接口，接收 `messages` 并返回 `content`。返回结构建议最简单为：

```json
{ "content": "回复内容" }
```

- 若需鉴权：沿用系统登录态，或为该接口单独校验签名/密钥（对应前端 `VITE_CHAT_API_KEY`）。

### Nginx 反向代理示例（生产）

```nginx
location /api/ {
  proxy_pass https://your-backend/;
  rewrite ^/api/(.*)$ /$1 break;
  proxy_set_header Host $host;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
}
```

## 可配置与扩展

- 上下文片段长度：`src/stores/chat.ts` 中 `contentSnippet` 约截断至 800 字符，可自行调整。
- UI 风格与位置：`src/components/HelpChat.vue` 中的样式类、窗口布局与按钮位置均可自定义。
- 流式输出：当前未实现 SSE/WebSocket 流式；可在 `src/services/chat.ts` 中扩展 `stream` 并在组件内逐步渲染。
- 国际化：文案目前为中文，如需 i18n 可结合项目内的多语言能力进行抽取。

## 常见问题

- 403 未授权：确认已登录或后端放行该接口；检查 `VITE_CHAT_API_KEY` 是否正确。
- 代理无效：确保设置了 `VITE_API_BASE_URL` 并重启前端；生产环境请配置反向代理。
- 加入文章失败：后端文章详情接口不可用或返回空内容；查看通知提示并检查网络请求。
- 返回格式不匹配：调整 `src/services/chat.ts` 的解析逻辑以适配你的返回结构。

## 验收清单

- 首页与文章详情页能看到“加入对话”按钮并可点击。
- 点击右下角按钮能打开/关闭对话窗口，输入问题后能收到回复。
- 加入文章后，在对话窗口顶部能看到“已添加的参考文章”列表。
- 后端接口异常时，能看到错误提示（toast），且页面不崩溃。
- 开发环境代理工作正常：`/api/chat/completion` 能路由到后端。

## 部署要点

- 生产环境请在 `.env.production` 填写 `VITE_CHAT_API_URL`（或配好反向代理），以及必要的 `VITE_CHAT_API_KEY`。
- 构建：`pnpm build`；如使用 SSG/PWA，遵循模板部署说明。

---

如需我代为适配后端返回结构或改造流式输出，请提供你的接口地址与示例返回，我会直接更新前端服务与组件。